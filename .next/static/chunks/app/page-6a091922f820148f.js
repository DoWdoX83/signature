(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{6100:(e,t,r)=>{Promise.resolve().then(r.bind(r,9547))},9547:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>d});var n=r(5155),l=r(2115),s=r(4054),i=r(6785),a=r(2834);function d(){let[e,t]=(0,l.useState)(null),[r,d]=(0,l.useState)(null),[c,o]=(0,l.useState)(!1),[u,h]=(0,l.useState)(!1),x=(0,l.useRef)(null),m=(0,l.useRef)(null),[p,b]=(0,l.useState)(!0),[f,v]=(0,l.useState)(!1),[g,j]=(0,l.useState)(null),[w,y]=(0,l.useState)(""),[N,k]=(0,l.useState)(""),[C,S]=(0,l.useState)(!1),[E,L]=(0,l.useState)(""),[R,z]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let e=m.current;if(!e)return;let t=new ResizeObserver(()=>{window.dispatchEvent(new Event("resize"))});return t.observe(e),()=>{t.disconnect()}},[]),(0,l.useEffect)(()=>{let e=window.matchMedia?window.matchMedia("(pointer: coarse), (max-width: 640px)"):null,t=()=>S(!!e&&e.matches);return t(),null==e||e.addEventListener("change",t),()=>null==e?void 0:e.removeEventListener("change",t)},[]),(0,l.useEffect)(()=>{try{let e=new URLSearchParams(window.location.search);z("true"===e.get("isMobile"))}catch(e){}},[]);let[U,D]=(0,l.useState)(""),P=(0,l.useMemo)(()=>{if(!U)return"";try{let e=new URL(U);return e.searchParams.set("isMobile","true"),e.toString()}catch(e){return U+(U.includes("?")?"&":"?")+"isMobile=true"}},[U]),O=(0,l.useMemo)(()=>E?"".concat(E,"#view=FitH&toolbar=0&navpanes=0&statusbar=0&zoom=page-width"):"",[E]);(0,l.useEffect)(()=>()=>{try{E&&URL.revokeObjectURL(E)}catch(e){}},[E]);let _=(0,l.useCallback)(async e=>{let r=e[0];if(r){if("application/pdf"!==r.type)return void d("Veuillez d\xe9poser un PDF.");d(null),o(!0);try{try{E&&URL.revokeObjectURL(E)}catch(e){}let e=URL.createObjectURL(r);L(e);let n=new FormData;n.append("file",r);let l=await fetch("/api/upload",{method:"POST",body:n});if(!l.ok)throw Error("Upload error");let s=await l.json();t({id:s.id,url:""});let i=new URL(window.location.href);i.searchParams.set("docId",s.id);let a=i.toString();window.history.replaceState(null,"",a),D(a)}catch(e){d("\xc9chec de l'upload")}finally{o(!1)}}},[E]),M=(0,l.useCallback)(()=>{var e;null==(e=x.current)||e.clear()},[]),T=(0,l.useCallback)(async()=>{if(!e)return void d("Veuillez d'abord t\xe9l\xe9verser un PDF.");if(!x.current||x.current.isEmpty())return void d("Veuillez signer dans la zone de signature.");d(null);let t=x.current.getCanvas?x.current.getCanvas():null,r=t?(()=>{let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let r=e.getContext("2d");return r&&r.drawImage(t,0,0),function(e){let t=e.getContext("2d");if(!t)return e;let{width:r,height:n}=e,l=t.getImageData(0,0,r,n).data,s=null,i=null,a=null,d=null;for(let e=0;e<n;e++)for(let t=0;t<r;t++)0!==l[(e*r+t)*4+3]&&(null===s&&(s=e),(null===i||t<i)&&(i=t),(null===a||t>a)&&(a=t),d=e);if(null===s||null===i||null===a||null===d)return e;let c=a-i+1,o=d-s+1,u=document.createElement("canvas");u.width=c,u.height=o;let h=u.getContext("2d");return h?(h.drawImage(e,i,s,c,o,0,0,c,o),u):e}(e)})():x.current.getTrimmedCanvas?x.current.getTrimmedCanvas():(x.current.toDataURL,null),n=r?r.toDataURL("image/png"):x.current.toDataURL?x.current.toDataURL("image/png"):"";try{if(!(await fetch("/api/sign",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,signatureDataUrl:n})})).ok)throw Error("Sign error");j(null),R||v(!0)}catch(e){d("\xc9chec de l'enregistrement de la signature")}},[e,R]),F=w.trim().length>0&&N.trim().length>0,B=(0,l.useCallback)(async()=>{if(F)try{await fetch("/api/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({advisor:w.trim(),client:N.trim(),url:U,docId:null==e?void 0:e.id})}),v(!1)}catch(e){}},[w,N,F,U,null==e?void 0:e.id]);return(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"min-h-[33vh] sm:min-h-[40vh] bg-[var(--brand-green)] flex items-center justify-center",children:(0,n.jsx)("p",{className:"text-white font-extrabold text-2xl sm:text-3xl -mt-52",children:"Signature de document"})}),(0,n.jsxs)("div",{className:"relative z-10 w-[85vw] max-w-[1200px] -mt-[24vh] mx-auto mb-12 bg-white rounded-3xl shadow-2xl ring-1 p-4 ring-black/10 space-y-6",children:[(0,n.jsx)(s.Ay,{onDrop:_,multiple:!1,accept:{"application/pdf":[".pdf"]},children:e=>{let{getRootProps:t,getInputProps:r,isDragActive:l}=e;return(0,n.jsxs)("div",{...t(),className:"bg-[var(--green-light)] rounded-xl h-14 sm:h-16 cursor-pointer border border-green-200 border-dashed flex items-center justify-center",children:[(0,n.jsx)("input",{...r()}),(0,n.jsxs)("div",{className:"flex items-center justify-center gap-4 text-[#2d4c46] text-sm sm:text-base",children:[(0,n.jsxs)("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"#2d4c46",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,children:[(0,n.jsx)("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),(0,n.jsx)("polyline",{points:"17 8 12 3 7 8"}),(0,n.jsx)("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),(0,n.jsx)("span",{children:C?"Choisir le fichier":l?"D\xe9posez le fichier ici":"Drag and drop ou choisir un fichier \xe0 signer"})]}),c&&(0,n.jsx)("div",{className:"text-center mt-2 text-[#2d4c46]",children:"Envoi en cours..."})]})}}),(0,n.jsxs)("div",{className:"sm:flex gap-4",children:[(0,n.jsxs)("div",{className:"w-full sm:w-1/2",children:[(0,n.jsx)("div",{className:"text-gray-800 font-semibold",children:"Document"}),(0,n.jsx)("div",{className:"border border-[var(--border-subtle)] rounded-xl max-h-[350px] min-h-[350px] sm:min-h-[420px] sm:max-h-[420px] overflow-hidden bg-white flex items-center justify-center",children:E?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"hidden sm:block w-full",children:(0,n.jsx)("iframe",{src:O,className:"w-full h-[420px] border-0"})}),(0,n.jsx)("div",{className:"block sm:hidden w-full text-center p-4",children:(0,n.jsx)("a",{href:E,target:"_blank",rel:"noopener noreferrer",className:"inline-flex mt-3 items-center justify-center rounded-xl border border-[var(--border-subtle)] px-4 py-2",children:"Visualiser le PDF"})})]}):(0,n.jsxs)("div",{className:"text-center text-[#6c757d] py-16",children:[(0,n.jsxs)("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"#adb5bd",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":!0,className:"mx-auto",children:[(0,n.jsx)("rect",{x:"3",y:"3",width:"18",height:"14",rx:"2",ry:"2"}),(0,n.jsx)("line",{x1:"3",y1:"19",x2:"21",y2:"19"})]}),(0,n.jsx)("div",{className:"mt-2",children:"Aucun document import\xe9"})]})})]}),(0,n.jsxs)("div",{className:"sm:w-1/2 w-full",children:[(0,n.jsx)("div",{className:"text-gray-800 font-semibold",children:"Signature"}),(0,n.jsxs)("div",{ref:m,className:"relative border border-[var(--border-subtle)] rounded-xl bg-white h-[150px] sm:h-[420px] overflow-hidden",children:[p&&(0,n.jsx)("div",{className:"absolute inset-0 z-10 flex items-center justify-center pointer-events-none",children:(0,n.jsx)("svg",{width:"60%",height:"60",viewBox:"0 0 300 60",children:(0,n.jsx)("path",{d:"M5 40 C 40 10, 80 60, 120 30 S 200 40, 295 20",fill:"none",stroke:"#000",strokeWidth:"3",style:{animation:"stroke 2.6s ease-in-out infinite"}})})}),(0,n.jsx)(i.A,{ref:e=>{x.current=e},onBegin:()=>b(!1),canvasProps:{style:{width:"100%",height:"100%",position:"absolute",inset:0,display:"block",touchAction:"none"}},penColor:"#000",backgroundColor:"#fff"})]}),(0,n.jsxs)("div",{className:"flex justify-end gap-3 pt-2 h-[50px]",children:[(0,n.jsx)("button",{onClick:()=>{M(),b(!0)},className:"bg-white border border-[var(--border-subtle)] rounded-xl px-4 py-2 cursor-pointer",children:"Effacer"}),(0,n.jsx)("button",{onClick:T,disabled:!e,className:"bg-[var(--green-light)] text-[#2d4c46] font-semibold rounded-xl px-4 py-2 disabled:opacity-50 cursor-pointer",children:"Sauvegarder"})]})]})]})]}),e&&P&&(0,n.jsx)("button",{onClick:()=>h(!0),className:"fixed right-4 bottom-4 w-16 h-16 rounded-full border border-[#ced4da] bg-white shadow-[0_2px_10px_rgba(0,0,0,0.15)] flex items-center justify-center z-50",style:{marginRight:"env(safe-area-inset-right)",marginBottom:"env(safe-area-inset-bottom)"},"aria-label":"Ouvrir le QR",children:(0,n.jsx)(a.X,{value:P,size:40})}),u&&P&&(0,n.jsx)("div",{onClick:()=>h(!1),className:"fixed inset-0 bg-black/50 flex items-center justify-center z-[60]",children:(0,n.jsxs)("div",{onClick:e=>e.stopPropagation(),className:"bg-white p-6 rounded-2xl min-w-80 text-center",children:[(0,n.jsx)("h3",{children:"Scanner pour signer"}),(0,n.jsx)("div",{className:"flex justify-center mt-4",children:(0,n.jsx)(a.X,{value:P,size:280})}),(0,n.jsx)("div",{className:"mt-4",children:(0,n.jsx)("button",{onClick:()=>h(!1),className:"border border-[var(--border-subtle)] rounded-xl px-3.5 py-2.5",children:"Fermer"})})]})}),f&&(0,n.jsx)("div",{onClick:()=>{v(!1)},className:"fixed inset-0 bg-black/50 flex items-center justify-center z-[70]",children:(0,n.jsxs)("div",{onClick:e=>e.stopPropagation(),className:"bg-white p-6 rounded-2xl max-w-[90vw] w-[560px] text-left",children:[(0,n.jsx)("h3",{className:"text-center",children:"Envoyer le document par email"}),(0,n.jsxs)("div",{className:"mt-5",children:[(0,n.jsx)("label",{className:"block text-sm text-[#495057] mb-1",children:"Email conseiller"}),(0,n.jsx)("input",{type:"email",value:w,onChange:e=>y(e.target.value),placeholder:"exemple@exemple.ch",className:"w-full border border-[var(--border-subtle)] rounded-xl px-3.5 py-2.5 outline-none"})]}),(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("label",{className:"block text-sm text-[#495057] mb-1",children:"Email client"}),(0,n.jsx)("input",{type:"email",value:N,onChange:e=>k(e.target.value),placeholder:"exemple@elyx-finance.ch",className:"w-full border border-[var(--border-subtle)] rounded-xl px-3.5 py-2.5 outline-none"})]}),(0,n.jsxs)("div",{className:"mt-6 flex justify-center gap-3",children:[(0,n.jsx)("a",{href:(null==e?void 0:e.id)?"/api/document/".concat(e.id):"#",className:"rounded-xl px-4 py-2 border border-[var(--border-subtle)] cursor-pointer",download:!0,children:"T\xe9l\xe9charger"}),(0,n.jsx)("button",{onClick:B,disabled:!F,className:"rounded-xl px-4 py-2 font-semibold text-white disabled:opacity-50 cursor-pointer",style:{background:"var(--brand-green)"},children:"Envoyer"})]})]})}),r&&(0,n.jsx)("p",{className:"text-red-600 text-center",children:r})]})}}},e=>{e.O(0,[785,17,441,255,358],()=>e(e.s=6100)),_N_E=e.O()}]);